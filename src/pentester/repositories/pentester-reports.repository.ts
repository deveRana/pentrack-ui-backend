// src/pentester/repositories/pentester-reports.repository.ts

import { Injectable } from '@nestjs/common';
import { PrismaService } from '@core/database/prisma.service';
import { ReportStatus } from '@prisma/client';

@Injectable()
export class PentesterReportsRepository {
    constructor(private readonly prisma: PrismaService) { }

    async findAllReports(params: {
        pentesterId: string;
        page: number;
        limit: number;
        search?: string;
        status?: string;
    }) {
        const { pentesterId, page, limit, search, status } = params;
        const skip = (page - 1) * limit;

        const where: any = {
            pentesterId,
        };

        if (search) {
            where.OR = [
                { project: { name: { contains: search, mode: 'insensitive' } } },
                { fileName: { contains: search, mode: 'insensitive' } },
            ];
        }

        if (status && status !== 'all') {
            where.status = status as ReportStatus;
        }

        const [reports, total] = await Promise.all([
            this.prisma.report.findMany({
                where,
                skip,
                take: limit,
                orderBy: { submittedAt: 'desc' },
                include: {
                    project: {
                        select: {
                            id: true,
                            name: true,
                            client: {
                                select: {
                                    companyName: true,
                                    user: { select: { email: true } },
                                },
                            },
                            serviceCategory: {
                                select: { name: true },
                            },
                        },
                    },
                    reviewer: {
                        select: {
                            firstName: true,
                            lastName: true,
                            email: true,
                        },
                    },
                },
            }),
            this.prisma.report.count({ where }),
        ]);

        return { reports, total };
    }

    async findReportById(reportId: string, pentesterId: string) {
        return this.prisma.report.findFirst({
            where: {
                id: reportId,
                pentesterId,
            },
            include: {
                project: {
                    select: {
                        id: true,
                        name: true,
                        client: {
                            select: {
                                companyName: true,
                                user: { select: { email: true } },
                            },
                        },
                        serviceCategory: {
                            select: { name: true },
                        },
                    },
                },
                reviewer: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
            },
        });
    }

    async findReportDetails(reportId: string, pentesterId: string) {
        return this.prisma.report.findFirst({
            where: {
                id: reportId,
                pentesterId,
            },
            include: {
                project: {
                    select: {
                        id: true,
                        name: true,
                        client: {
                            select: {
                                companyName: true,
                                user: { select: { email: true } },
                            },
                        },
                        serviceCategory: {
                            select: { name: true },
                        },
                    },
                },
                reviewer: {
                    select: {
                        firstName: true,
                        lastName: true,
                        email: true,
                    },
                },
                checks: {
                    include: {
                        securityCheck: true,
                    },
                },
                history: {
                    orderBy: { createdAt: 'desc' },
                },
            },
        });
    }

    async getReportsStats(pentesterId: string) {
        const [total, underReview, approved, rejected] = await Promise.all([
            this.prisma.report.count({
                where: { pentesterId },
            }),
            this.prisma.report.count({
                where: { pentesterId, status: 'UNDER_REVIEW' },
            }),
            this.prisma.report.count({
                where: { pentesterId, status: 'APPROVED' },
            }),
            this.prisma.report.count({
                where: { pentesterId, status: 'REJECTED' },
            }),
        ]);

        return { total, underReview, approved, rejected };
    }

    async createReport(data: {
        projectId: string;
        pentesterId: string;
        fileName: string;
        fileUrl: string;
        fileSize: number;
        fileType: string;
        submissionNotes?: string;
        version: number;
    }) {
        return this.prisma.report.create({
            data: {
                projectId: data.projectId,
                pentesterId: data.pentesterId,
                fileName: data.fileName,
                fileUrl: data.fileUrl,
                fileSize: data.fileSize,
                fileType: data.fileType,
                submissionNotes: data.submissionNotes,
                version: data.version,
                status: 'PENDING',
            },
        });
    }

    async createReportChecks(reportId: string, checks: Record<string, boolean>) {
        const checkEntries = Object.entries(checks).map(([name, completed]) => ({
            reportId,
            securityCheckId: name,
            completed,
        }));

        return this.prisma.reportCheck.createMany({
            data: checkEntries as any,
        });
    }

    async getLatestReportVersion(projectId: string) {
        const latestReport = await this.prisma.report.findFirst({
            where: { projectId },
            orderBy: { version: 'desc' },
            select: { version: true },
        });

        return latestReport?.version || 0;
    }
}