// src/pentester/repositories/pentester-projects.repository.ts

import { Injectable } from '@nestjs/common';
import { PrismaService } from '@core/database/prisma.service';
import { ProjectStatus } from '@prisma/client';

@Injectable()
export class PentesterProjectsRepository {
    constructor(private readonly prisma: PrismaService) { }

    async findAllProjects(params: {
        pentesterId: string;
        page: number;
        limit: number;
        search?: string;
        status?: string;
        service?: string;
    }) {
        const { pentesterId, page, limit, search, status, service } = params;
        const skip = (page - 1) * limit;

        const where: any = {
            pentesterId,
            deletedAt: null,
        };

        if (search) {
            where.OR = [
                { name: { contains: search, mode: 'insensitive' } },
                { description: { contains: search, mode: 'insensitive' } },
            ];
        }

        if (status && status !== 'all') {
            where.status = status as ProjectStatus;
        }

        if (service && service !== 'all') {
            where.serviceCategory = { name: service };
        }

        const [projects, total] = await Promise.all([
            this.prisma.project.findMany({
                where,
                skip,
                take: limit,
                orderBy: { updatedAt: 'desc' },
                include: {
                    client: {
                        select: {
                            companyName: true,
                            address: true,
                        },
                    },
                    serviceCategory: {
                        select: { name: true },
                    },
                },
            }),
            this.prisma.project.count({ where }),
        ]);

        return { projects, total };
    }

    async findProjectById(projectId: string, pentesterId: string) {
        return this.prisma.project.findFirst({
            where: {
                id: projectId,
                pentesterId,
                deletedAt: null,
            },
            include: {
                client: {
                    select: {
                        companyName: true,
                        address: true,
                        pointOfContact: true,
                        pointOfContactEmail: true,
                        pointOfContactPhone: true,
                        user: {
                            select: {
                                email: true,
                                phone: true,
                            },
                        },
                    },
                },
                radmin: {
                    select: {
                        firstName: true,
                        lastName: true,
                    },
                },
                serviceCategory: {
                    select: { name: true },
                },
            },
        });
    }

    async getProjectsStats(pentesterId: string) {
        const [total, active, completed, notStarted, inProgress, testingComplete] = await Promise.all([
            this.prisma.project.count({
                where: { pentesterId, deletedAt: null },
            }),
            this.prisma.project.count({
                where: {
                    pentesterId,
                    status: { in: ['NOT_STARTED', 'IN_PROGRESS', 'TESTING_COMPLETE'] },
                    deletedAt: null,
                },
            }),
            this.prisma.project.count({
                where: { pentesterId, status: 'COMPLETED', deletedAt: null },
            }),
            this.prisma.project.count({
                where: { pentesterId, status: 'NOT_STARTED', deletedAt: null },
            }),
            this.prisma.project.count({
                where: { pentesterId, status: 'IN_PROGRESS', deletedAt: null },
            }),
            this.prisma.project.count({
                where: { pentesterId, status: 'TESTING_COMPLETE', deletedAt: null },
            }),
        ]);

        return {
            totalProjects: total,
            activeProjects: active,
            completedProjects: completed,
            notStarted,
            inProgress,
            testingComplete,
        };
    }

    async updateProjectStatus(projectId: string, pentesterId: string, status: ProjectStatus) {
        return this.prisma.project.update({
            where: { id: projectId },
            data: { status },
        });
    }

    async getAvailableProjectsForUpload(pentesterId: string) {
        return this.prisma.project.findMany({
            where: {
                pentesterId,
                status: { in: ['IN_PROGRESS', 'TESTING_COMPLETE'] },
                deletedAt: null,
            },
            select: {
                id: true,
                name: true,
                status: true,
                client: {
                    select: { companyName: true },
                },
                serviceCategory: {
                    select: { name: true },
                },
            },
        });
    }
}