// src/pentester/repositories/pentester.repository.ts

import { Injectable } from '@nestjs/common';
import { PrismaService } from '@core/database/prisma.service';

@Injectable()
export class PentesterRepository {
    constructor(private readonly prisma: PrismaService) { }

    async findPentesterByUserId(userId: string) {
        return this.prisma.pentester.findUnique({
            where: { userId },
            include: {
                user: {
                    select: {
                        id: true,
                        email: true,
                        firstName: true,
                        lastName: true,
                        phone: true,
                        status: true,
                    },
                },
            },
        });
    }

    async updatePentesterProfile(userId: string, data: any) {
        return this.prisma.$transaction(async (tx) => {
            await tx.user.update({
                where: { id: userId },
                data: {
                    firstName: data.firstName,
                    lastName: data.lastName,
                    phone: data.phone,
                },
            });

            return tx.pentester.update({
                where: { userId },
                data: {
                    specialization: data.specialization,
                    location: data.location,
                    bio: data.bio,
                },
                include: {
                    user: true,
                },
            });
        });
    }

    async getDashboardStats(userId: string) {
        const [activeProjects, upcomingDeadlines, underReview, rejected] = await Promise.all([
            this.prisma.project.count({
                where: {
                    pentesterId: userId,
                    status: { in: ['NOT_STARTED', 'IN_PROGRESS', 'TESTING_COMPLETE'] },
                    deletedAt: null,
                },
            }),
            this.prisma.project.count({
                where: {
                    pentesterId: userId,
                    deadline: { lte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) },
                    status: { notIn: ['COMPLETED', 'REJECTED'] },
                    deletedAt: null,
                },
            }),
            this.prisma.report.count({
                where: {
                    pentesterId: userId,
                    status: 'UNDER_REVIEW',
                },
            }),
            this.prisma.report.count({
                where: {
                    pentesterId: userId,
                    status: 'REJECTED',
                },
            }),
        ]);

        return { activeProjects, upcomingDeadlines, underReview, rejected };
    }

    async getUpcomingDeadlines(userId: string, limit: number = 5) {
        return this.prisma.project.findMany({
            where: {
                pentesterId: userId,
                deadline: { lte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) },
                status: { notIn: ['COMPLETED', 'REJECTED'] },
                deletedAt: null,
            },
            take: limit,
            orderBy: { deadline: 'asc' },
            include: {
                client: { select: { companyName: true } },
            },
        });
    }

    async getMyProjects(userId: string, limit: number = 5) {
        return this.prisma.project.findMany({
            where: {
                pentesterId: userId,
                deletedAt: null,
            },
            take: limit,
            orderBy: { updatedAt: 'desc' },
            include: {
                client: { select: { companyName: true } },
                serviceCategory: { select: { name: true } },
            },
        });
    }

    async getRecentActivities(userId: string, limit: number = 10) {
        return this.prisma.projectActivity.findMany({
            where: { userId },
            take: limit,
            orderBy: { createdAt: 'desc' },
            include: {
                project: {
                    select: {
                        name: true,
                        client: { select: { companyName: true } },
                    },
                },
            },
        });
    }

    async getProfileStats(userId: string) {
        const [totalProjects, completedProjects, inProgressProjects] = await Promise.all([
            this.prisma.project.count({
                where: { pentesterId: userId, deletedAt: null },
            }),
            this.prisma.project.count({
                where: { pentesterId: userId, status: 'COMPLETED', deletedAt: null },
            }),
            this.prisma.project.count({
                where: {
                    pentesterId: userId,
                    status: { in: ['NOT_STARTED', 'IN_PROGRESS', 'TESTING_COMPLETE'] },
                    deletedAt: null,
                },
            }),
        ]);

        const successRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;

        return {
            totalProjects,
            completedProjects,
            inProgressProjects,
            successRate: `${successRate}%`,
        };
    }
}